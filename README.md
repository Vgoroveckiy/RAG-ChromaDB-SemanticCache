# RAG система для каталога ювелирных изделий (ChromaDB + семантический кэш)

Профессиональная система Retrieval-Augmented Generation для работы с каталогами ювелирных изделий с возможностями семантического кэширования.

## Ключевые возможности

### Основная функциональность
- **Семантический поиск** с использованием эмбеддингов HuggingFace
- **Двухуровневое хранилище**:
  - Основной индекс ChromaDB для документов
  - Отдельная коллекция для кэширования вопросов и ответов
- **Автоматическая индексация**:
  - Обнаружение изменений файлов через хеши SHA-256
  - Инкрементальные обновления
  - Очистка удаленных файлов

### Система кэширования
- **Семантическое сопоставление** (порог расстояния L2)
- **TTL-истечение** (настраивается)
- **Инвалидация по источнику** (при изменении документов)
- **Хранение метаданных**:
  - Временные метки
  - Ссылки на источники
  - Тексты ответов

### Поддерживаемые форматы
| Формат | Метод обработки |
|--------|-------------------|
| JSON   | Прямой парсинг с проверкой хешей |
| PDF    | Извлечение через библиотеку Unstructured |
| DOCX   | Извлечение через библиотеку Unstructured |
| TXT    | Прямая обработка текста |

## Архитектура системы

### Технологический стек
| Компонент | Технология | Назначение |
|-----------|------------|---------|
| Векторная БД | ChromaDB | Хранение и поиск документов |
| Эмбеддинги | HuggingFace (all-MiniLM-L6-v2) | Векторизация текста |
| Языковая модель | OpenAI GPT | Генерация ответов |
| Обработка текста | Unstructured, LangChain | Парсинг и разбиение файлов |

### Основные компоненты

#### Класс VectorDatabase
```python
class VectorDatabase:
    """Управляет коллекциями ChromaDB для документов и кэша"""
    def __init__(db_path, cache_path, embeddings)
    def load_or_create(force_recreate=False)
    def load_or_create_cache(force_recreate=False)
    def add_to_cache(question, answer, sources)
    def get_cached_answer(question, similarity_threshold=0.1)
    def delete_documents(doc_ids)
    def cleanup_expired_cache_entries(ttl_days)
```

#### Рабочий процесс RAGSystem
1. **Инициализация**:
   - Загружает/создает коллекции ChromaDB
   - Настраивает цепочку LLM с шаблоном промпта
   - Конфигурирует ретривер (поиск по сходству k=4)

2. **Обработка запроса**:
   ```mermaid
   graph TD
     A[Вопрос пользователя] --> B{Проверить кэш}
     B -->|Есть| C[Вернуть кэшированный ответ]
     B -->|Нет| D[Найти релевантные документы]
     D --> E[Сгенерировать ответ с LLM]
     E --> F[Кэшировать ответ]
     F --> G[Вернуть ответ]
   ```

## Установка и конфигурация

### Требования
- Python 3.9+
- Ключ API OpenAI
- 4GB+ RAM для работы с эмбеддингами

### Установка
```bash
pip install -r requirements.txt
pip install unstructured[local-inference]  # Для поддержки PDF/DOCX
```

### Структура проекта
```
.
├── chroma_db/             # Основное векторное хранилище
├── chroma_cache/          # Семантический кэш
├── data/                  # Хранилище документов
│   ├── catalog.json       # Пример JSON каталога
│   ├── products.pdf       # Описания товаров  
│   └── materials.docx     # Спецификации материалов
├── config.py              # Конфигурация
├── rag_system.py          # Основная реализация RAG
└── README.md              # Документация
```

### Конфигурация (config.py)
```python
class Config:
    # Пути ChromaDB
    CHROMA_DB_PATH = "chroma_db"          # Основной индекс документов
    CHROMA_CACHE_PATH = "semantic_cache"  # Кэш вопросов/ответов
    
    # Обработка документов
    INPUT_DIR = "data"                    # Входная директория
    CHUNK_SIZE = 1000                     # Конфигурация разделителя текста
    CHUNK_OVERLAP = 200
    
    # Модели
    EMBEDDING_MODEL = "sentence-transformers/all-MiniLM-L6-v2"
    LLM_MODEL = "gpt-3.5-turbo"
    LLM_TEMPERATURE = 0.3
    
    # Настройки кэша  
    CACHE_TTL_DAYS = 7                    # Время жизни
    SIMILARITY_THRESHOLD = 0.1            # Порог совпадения для кэша
```

## Режимы работы

### Консольный интерфейс
| Код | Режим | Описание |
|------|------|-------------|
| 1 | Очистка данных | Удаление индексов ChromaDB |
| 2 | Индексация документов | Обработка файлов в data/ |
| 3 | Интерактивный чат | Интерфейс вопросов и ответов |
| 4 | Тестовые вопросы | Предопределенный набор вопросов |
| 5 | Очистка кэша | Удаление семантического кэша |
| 0 | Выход | Завершение работы системы |

### Программный API
```python
# Инициализация системы
vector_db = VectorDatabase(config.CHROMA_DB_PATH, 
                          config.CHROMA_CACHE_PATH,
                          embeddings)

# Индексация документов
documents = parse_files(config.INPUT_DIR, vector_db)

# Запрос с кэшированием
rag = RAGSystem(config)
answer = rag.query("Покажите кольца с изумрудами", use_cache=True)
```

## Безопасность и защита данных
- Все данные хранятся локально
- Документы не отправляются за пределы системы
- Кэш использует семантическое сопоставление (не хранит сырые данные)

## Лицензия
MIT License

> Эта документация предоставляет полное техническое описание реализации RAG системы.
